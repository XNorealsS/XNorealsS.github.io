<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shader System</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-md">
        <!-- Login Page -->
        <div id="loginPage" class="bg-white rounded-lg shadow-lg p-6 border border-blue-200">
            <h1 class="text-2xl font-bold text-blue-800 mb-6 text-center">Wallhack System</h1>
            <div class="mb-4">
                <label for="userKeyLogin" class="block text-sm font-medium text-blue-700 mb-1">User Key:</label>
                <input type="text" id="userKeyLogin" placeholder="Enter your user key" 
                    class="w-full px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label for="transactionId" class="block text-sm font-medium text-blue-700 mb-1">Transaction ID:</label>
                <input type="text" id="transactionId" placeholder="Enter your transaction ID" 
                    class="w-full px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button id="loginButton" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-300 ease-in-out flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                </svg>
                Login
            </button>
        </div>
        <!-- User Settings Page (initially hidden) -->
        <div id="settingsPage" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold text-blue-800">User Settings</h1>
                <button id="logoutButton" class="text-blue-600 hover:text-blue-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>
            <div class="grid grid-cols-1 gap-6">
                <!-- User Info Card -->
                <div class="bg-white rounded-lg shadow-lg p-6 border border-blue-200">
                    <h2 class="text-xl font-semibold text-blue-700 mb-3">Account Information</h2>
                    <p class="text-gray-700"><span class="font-medium">Key :</span> <span id="userKeyDisplay"></span></p>
                    <p class="text-gray-700"><span class="font-medium">trx_id :</span> <span id="registratorDisplay"></span></p>
                    <p class="text-gray-700"><span class="font-medium">Connected Devices:</span> <span id="deviceCountDisplay"></span></p>
                </div>
                <!-- Shader Color Settings Card -->
                <div class="bg-white rounded-lg shadow-lg p-6 border border-blue-200">
                    <h2 class="text-xl font-semibold text-blue-700 mb-4">Shader Color Settings</h2>
                    <div class="mb-4">
                        <label for="colorPicker" class="block text-sm font-medium text-blue-700 mb-1">Choose a color:</label>
                        <input type="color" id="colorPicker" value="#ffff00" 
                            class="h-12 w-24 border border-blue-300 rounded-md cursor-pointer">
                        <div id="colorPreview" class="mt-2 h-8 w-full rounded-md border border-blue-300"></div>
                    </div>
                    <div class="mb-6">
                        <label for="alpha" class="block text-sm font-medium text-blue-700 mb-1">
                            Alpha (Transparency): <span id="alphaValue">0.8</span>
                        </label>
                        <input type="range" id="alpha" min="0" max="1" step="0.01" value="0.8"
                            class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <button id="saveColorButton" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-300 ease-in-out flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Save Color Settings
                    </button>
                </div>
                <!-- Device Reset Card -->
                <div class="bg-white rounded-lg shadow-lg p-6 border border-blue-200">
                    <h2 class="text-xl font-semibold text-blue-700 mb-4">Device Management</h2>
                    <p class="text-gray-600 mb-4">Reset all connected devices.</p>
                    <button id="resetDevicesButton" 
                        class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-md transition duration-300 ease-in-out flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                        </svg>
                        Reset All Devices
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const API_BASE_URL = 'https://xnorealszzid.my.id/api';
        let userSession = null;

        // Check if user is already logged in
        function checkSession() {
            const savedSession = localStorage.getItem('shaderSession');
            if (savedSession) {
                userSession = JSON.parse(savedSession);
                showSettingsPage();
                updateUserInfo(); // Pastikan ini dipanggil saat halaman dimuat
            } else {
                showLoginPage();
            }
        }

        // Show settings page and initialize UI
        function showSettingsPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('settingsPage').classList.remove('hidden');
            updateColorPreview(); // Pastikan preview warna diinisialisasi
        }

        // Login functionality
        document.getElementById('loginButton').addEventListener('click', () => {
            const userKey = document.getElementById('userKeyLogin').value;
            const transactionId = document.getElementById('transactionId').value;
            axios.post(`${API_BASE_URL}/login`, {
                user_key: userKey,
                trxid: transactionId
            }).then(response => {
                if (response.data.status) {
                    userSession = response.data.data;
                    localStorage.setItem('shaderSession', JSON.stringify(userSession));
                    showSettingsPage();
                    updateUserInfo();
                    showNotification('Login successful!', 'success');
                } else {
                    showNotification(response.data.reason || 'Invalid credentials', 'error');
                }
            }).catch(error => {
                console.error(error);
                showNotification('Login failed. Please try again.', 'error');
            });
        });

        // Logout functionality
        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('shaderSession');
            userSession = null;
            showLoginPage();
            showNotification('Logged out successfully', 'success');
        });

        // Color picker functionality
        const colorPicker = document.getElementById('colorPicker');
        const colorPreview = document.getElementById('colorPreview');
        const alpha = document.getElementById('alpha');
        const alphaValue = document.getElementById('alphaValue');

        function updateColorPreview() {
            const color = colorPicker.value;
            const transparency = alpha.value;
            colorPreview.style.backgroundColor = color;
            colorPreview.style.opacity = transparency;
            alphaValue.textContent = transparency;
        }

        colorPicker.addEventListener('input', updateColorPreview);
        alpha.addEventListener('input', updateColorPreview);

        // Save color settings
        document.getElementById('saveColorButton').addEventListener('click', () => {
            if (!userSession) {
                showNotification('You must be logged in', 'error');
                return;
            }
            const color = colorPicker.value;
            const transparency = alpha.value;
            const rgb = hexToRgb(color);
            const shaderColor = `vec4(${rgb.r / 255}, ${rgb.g / 255}, ${rgb.b / 255}, ${transparency})`;
            axios.post(`${API_BASE_URL}/update-color`, {
                user_key: userSession.user_key,
                shader_color: shaderColor
            }).then(response => {
                if (response.data.status) {
                    userSession.shader_color = shaderColor;
                    localStorage.setItem('shaderSession', JSON.stringify(userSession));
                    showNotification('Shader color saved successfully!', 'success');
                } else {
                    showNotification(response.data.reason || 'Failed to save shader color', 'error');
                }
            }).catch(error => {
                console.error(error);
                showNotification('Failed to save shader color.', 'error');
            });
        });

        // Reset devices functionality
        document.getElementById('resetDevicesButton').addEventListener('click', () => {
            if (!userSession) {
                showNotification('You must be logged in', 'error');
                return;
            }
            if (confirm('Are you sure you want to reset all devices? This action cannot be undone.')) {
                axios.post(`${API_BASE_URL}/reset-devices`, {
                    user_key: userSession.user_key
                }).then(response => {
                    if (response.data.status) {
                        userSession.devices = "";
                        localStorage.setItem('shaderSession', JSON.stringify(userSession));
                        updateUserInfo();
                        showNotification('All devices have been reset successfully!', 'success');
                    } else {
                        showNotification(response.data.reason || 'Failed to reset devices', 'error');
                    }
                }).catch(error => {
                    console.error(error);
                    showNotification('Failed to reset devices.', 'error');
                });
            }
        });

        // UI helpers
        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('settingsPage').classList.add('hidden');
        }

        function showSettingsPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('settingsPage').classList.remove('hidden');
            updateColorPreview();
        }

        function updateUserInfo() {
            document.getElementById('userKeyDisplay').textContent = userSession.user_key;
            document.getElementById('registratorDisplay').textContent = userSession.registrator || 'N/A';
            // Count devices
            const deviceCount = userSession.devices ? userSession.devices.split(',').length : 0;
            document.getElementById('deviceCountDisplay').textContent = deviceCount;

            // Set color if available
            if (userSession.shader_color) {
                try {
                    // Parse shader color from vec4 format
                    const colorRegex = /vec4(([d.]+),s*([d.]+),s*([d.]+),s*([d.]+))/;
                    const match = userSession.shader_color.match(colorRegex);
                    if (match) {
                        const r = Math.round(parseFloat(match[1]) * 255); // Convert to RGB
                        const g = Math.round(parseFloat(match[2]) * 255);
                        const b = Math.round(parseFloat(match[3]) * 255);
                        const a = parseFloat(match[4]); // Alpha value

                        // Convert RGB to hex
                        const hexColor = rgbToHex(r, g, b);

                        // Set color picker and alpha values
                        colorPicker.value = hexColor;
                        alpha.value = a;

                        // Update the color preview
                        updateColorPreview();
                    }
                } catch (e) {
                    console.error("Failed to parse shader color", e);
                }
            }
        }

        // Helper functions
        function hexToRgb(hex) {
            const bigint = parseInt(hex.slice(1), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return { r, g, b };
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-md shadow-lg ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white max-w-xs z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Check session on load
        checkSession();
    </script>
</body>
</html>